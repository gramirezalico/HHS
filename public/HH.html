<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de cajas</title>
    <!-- Restaurar estilos -->
    <link rel="stylesheet" href="./HH.css">
    <link rel="stylesheet" href="./main.css">
</head>
<body>
    <div class="container">
        <h1>Administración de cajas</h1>
        <div class="button-group">
            <button class="btn btn-add">Agregar</button>
            <button class="btn btn-close-main" title="Cerrar modal/limpiar">Cerrar</button>
            <button class="btn btn-logout">Cerrar sesión</button>
        </div>
        <div id="packagesList" class="packages-list"></div>
        <div class="employe">
            <span class="employee-name">Usuario: <span id="userName"></span></span>
        </div>
    </div>
    <div class="status">Ready</div>

    <div id="addPackagingModal" class="modal">
        <div class="modal-content">
            <h2>Agregar embalaje</h2>
            <div class="order-info">Orden 1 Línea 2 Embarque 1 Línea 1</div>
            <div class="tab-group">
                <button type="button" class="tab-btn active" id="tabCajas">Cajas</button>
                <button type="button" class="tab-btn" id="tabPallet">Pallet</button>
            </div>
            <form id="packagingForm">
                <!-- Cajas -->
                <div id="tabCajasContent">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="packagingType">Tipo embalaje</label>
                            <select name="packagingTypeList1" id="packagingTypeList1">
                                <option value="">CAJA C01</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="length">Largo</label>
                            <input type="text" id="length" class="number-input" value="46,00000">
                        </div>
                        <div class="form-group">
                            <label for="width">Ancho</label>
                            <input type="text" id="width" class="number-input" value="37,50000">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">Alto</label>
                            <input type="text" id="height" class="number-input" value="57,50000">
                        </div>
                        <div class="form-group">
                            <label for="um">UM</label>
                            <input type="text" id="um" class="text-input" value="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="unitWeight">Peso unita(kg)</label>
                            <input type="text" id="unitWeight" class="number-input wide-input" value="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="numPackages">No Embalajes</label>
                            <input type="text" id="numPackages" class="number-input" value="">
                        </div>
                    </div>
                    <div class="modal-button-group">
                        <button type="submit" class="btn btn-save">Guardar</button>
                        <button type="button" class="btn btn-close-packaging-modal">Cerrar</button>
                    </div>
                </div>
                <!-- Pallet -->
                <div id="tabPalletContent" style="display:none;">
                    <fieldset class="form-row">
                        <legend>Tipo de pallet</legend>
                        <label>
                            <input type="radio" name="palletType" value="NORMAL"> Normal
                        </label>
                        <label>
                            <input type="radio" name="palletType" value="MEDIANO"> Mediano
                        </label>
                        <label>
                            <input type="radio" name="palletType" value="GRANDE"> Grande
                        </label>
                        <div class="form-group">
                            <label for="palletTotalWeight">Peso total (kg)</label>
                            <input type="text" id="palletTotalWeight" class="number-input" value="">
                        </div>
                    </fieldset>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo embalaje</label>
                            <select class="pallet-caja-select">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="modal-button-group">
                        <button type="submit" class="btn btn-save">Guardar</button>
                        <button type="button" class="btn btn-close-packaging-modal">Cerrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="packagingTypeSelectionModal" class="modal">
        <div class="modal-content type-selection-content">
            <h2>Agregar embalaje</h2>
            <div class="type-list-container">
                <select name="packagingTypeList" id="packagingTypeList"></select>
            </div>
            <div class="modal-button-group">
                <button type="button" class="btn btn-cancel-selection">Cancelar</button>
                <button type="button" class="btn btn-ok-selection">Ok</button>
            </div>
        </div>
    </div>

    <div id="editPalletBoxesModal" class="modal">
        <div class="modal-content">
            <h2>Cajas Pallet Crear</h2>
            <div class="order-info">Orden 1 Linea 2 Embarque 1 Linea 1</div>
            <div class="input-row">
                <select class="box-select" id="boxSelect1">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty1" value="0" min="0">
            </div>
            <div class="input-row">
                <select class="box-select" id="boxSelect2">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty2" value="0" min="0">
            </div>
            <div class="input-row">
                <select class="box-select" id="boxSelect3">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty3" value="0" min="0">
            </div>
            <div class="input-row">
                <select class="box-select" id="boxSelect4">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty4" value="0" min="0">
            </div>
            <div class="modal-button-group button-group">
                <button class="cancel btn-close-pallet-boxes-modal">Cancelar</button>
                <button class="accept" id="acceptPalletBoxesBtn">Aceptar</button>
            </div>
        </div>
    </div>

    <button id="miBoton">Contar Registros</button>
    <!-- Limpieza: removido script obsoleto main-hh.js -->
    
<script type="module">
import { initDB, getAllData, addEntry } from './assets/js/modules/db.js';
import { populateSelect, renderEntries, wireEntryDeletion } from './assets/js/modules/ui.js';

// LISTA y borrado
const packagesList = document.getElementById('packagesList');
wireEntryDeletion(packagesList);

// Usuario
const userName = localStorage.getItem('userName');
if (userName) document.getElementById('userName').textContent = userName;

// Inicializar DB y cargar catálogo de cajas
initDB().then(()=>{
    getAllData().then(data=>{
        if(!data.length){
            fetch('./api/packingList').then(r=>r.json()).then(api=>{
                if(api.status==='success'){
                    api.value.forEach(item=>{ if(item.Packing_Description.includes('CAJA')) addEntry({kind:'CATALOGO', pkgCode:item.Packing_PkgCode}); });
                    populateSelect(document.getElementById('packagingTypeList1'), api.value.filter(i=>i.Packing_Description.includes('CAJA')));
                    // Popular selects de pallet
                    document.querySelectorAll('#tabPalletContent .pallet-caja-select').forEach(sel=>{
                        populateSelect(sel, api.value.filter(i=>i.Packing_Description.includes('CAJA')));
                    });
                }
            });
        } else {
            populateSelect(document.getElementById('packagingTypeList1'), data);
            document.querySelectorAll('#tabPalletContent .pallet-caja-select').forEach(sel=>populateSelect(sel, data));
        }
    });
    renderEntries(packagesList);
});

// Modal manejadores
const addPackagingModal = document.getElementById('addPackagingModal');
document.querySelector('.btn-add').addEventListener('click',()=>{ addPackagingModal.style.display='flex'; });
document.querySelector('.btn-close-packaging-modal').addEventListener('click',()=>{ addPackagingModal.style.display='none'; });

// Tabs
const tabBtnCajas = document.getElementById('tabCajas');
const tabBtnPallet = document.getElementById('tabPallet');
const tabCajasContent = document.getElementById('tabCajasContent');
const tabPalletContent = document.getElementById('tabPalletContent');

function activateTab(kind){
    if(kind==='Cajas'){
        tabBtnCajas.classList.add('active');
        tabBtnPallet.classList.remove('active');
        tabCajasContent.style.display='block';
        tabPalletContent.style.display='none';
    } else {
        tabBtnPallet.classList.add('active');
        tabBtnCajas.classList.remove('active');
        tabPalletContent.style.display='block';
        tabCajasContent.style.display='none';
    }
}
tabBtnCajas.addEventListener('click',()=>activateTab('Cajas'));
tabBtnPallet.addEventListener('click',()=>activateTab('Pallet'));

// Select caja principal (cajas tab)
const selectCaja = document.getElementById('packagingTypeList1');
selectCaja.addEventListener('change', ()=>{/* Placeholder para futura lógica de dimensiones */});

// Submit único que decide según tab activo
document.getElementById('packagingForm').addEventListener('submit', e=>{
    e.preventDefault();
    const isPallet = tabPalletContent.style.display==='block';
    if(!isPallet){
        // Guardar CAJA
        const pkgCode = selectCaja.value;
        if(!pkgCode){ alert('Seleccione caja'); return; }
        const length = Number(document.getElementById('length').value.replace(',', '.'))||0;
        const width = Number(document.getElementById('width').value.replace(',', '.'))||0;
        const height = Number(document.getElementById('height').value.replace(',', '.'))||0;
        const unitWeight = Number(document.getElementById('unitWeight').value.replace(',', '.'))||0;
        const numPackages = Number(document.getElementById('numPackages').value.replace(',', '.'))||0;
        addEntry({kind:'CAJA', pkgCode, length,width,height,unitWeight,numPackages});
    } else {
        // Guardar PALLET
        const palletType = (document.querySelector('input[name="palletType"]:checked')||{}).value || '';
        if(!palletType){ alert('Seleccione tipo de pallet'); return; }
        const palletTotalWeight = Number(document.getElementById('palletTotalWeight').value.replace(',', '.'))||0;
        const boxData = [];
        // Recorre filas pallet: select seguido de input number
        const rows = tabPalletContent.querySelectorAll('.form-row');
        rows.forEach(r=>{
            const sel = r.querySelector('.pallet-caja-select');
            const qtyInput = r.querySelector('input.number-input');
            if(sel && qtyInput){
                const code = sel.value;
                const qty = Number(qtyInput.value)||0;
                if(code && qty>0) boxData.push({pkgCode:code, qty});
            }
        });
        if(!boxData.length){ alert('Agregue al menos una caja con cantidad'); return; }
        addEntry({kind:'PALLET', palletType, palletTotalWeight, boxes: boxData, pkgCodes: boxData.map(b=>b.pkgCode)});
    }
    addPackagingModal.style.display='none';
    renderEntries(packagesList);
    e.target.reset();
    activateTab('Cajas');
});
</script>
</body>
</html>