<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de cajas</title>
    <link rel="stylesheet" href=".main.css">
</head>
<body>
    <div class="container">
        <h1>Administración de cajas</h1>
        <div class="button-group">
            <button class="btn btn-add">Agregar</button>
            <button class="btn btn-close-main" title="Cerrar modal/limpiar">Cerrar</button>
            <button class="btn btn-logout">Cerrar sesión</button>
        </div>
        <div id="packagesList" class="packages-list"></div>
        <div class="employe">
            <span class="employee-name">Usuario: <span id="userName"></span></span>
        </div>
    </div>
    <div class="status">Ready</div>

    <div id="addPackagingModal" class="modal">
        <div class="modal-content">
            <h2 style="text-align:center;">Agregar embalaje</h2>
            <div class="order-info">Orden 1 Línea 2 Embarque 1 Línea 1</div>
            <div class="tab-group" style="display: flex; border-bottom: 1.5px solid #e0e0e0; margin-bottom: 1.2em;">
                <button type="button" class="tab-btn active" id="tabCajas" style="flex:1; border:none; background:none; font-weight:bold; color:#2563eb; border-bottom:2.5px solid #2563eb; padding:0.7em 0; cursor:pointer;">Cajas</button>
                <button type="button" class="tab-btn" id="tabPallet" style="flex:1; border:none; background:none; font-weight:normal; color:#444; border-bottom:2.5px solid transparent; padding:0.7em 0; cursor:pointer;">Pallet</button>
            </div>
            <form id="packagingForm">
                <!-- Cajas -->
                <div id="tabCajasContent">
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label for="packagingType" style="min-width: 110px;">Tipo embalaje</label>
                            <select name="packagingTypeList1" id="packagingTypeList1" style="width: 100%;">
                                <option value="">CAJA C01</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 45%; min-width: 120px;">
                            <label for="length">Largo</label>
                            <input type="text" id="length" class="number-input" value="46,00000">
                        </div>
                        <div class="form-group" style="flex: 1 1 45%; min-width: 120px;">
                            <label for="width">Ancho</label>
                            <input type="text" id="width" class="number-input" value="37,50000">
                        </div>
                    </div>
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 45%; min-width: 120px;">
                            <label for="height">Alto</label>
                            <input type="text" id="height" class="number-input" value="57,50000">
                        </div>
                        <div class="form-group" style="flex: 1 1 45%; min-width: 120px;">
                            <label for="um">UM</label>
                            <input type="text" id="um" class="text-input" value="">
                        </div>
                    </div>
                    <div class="form-row" style="margin-bottom: 1.2em;">
                        <div class="form-group" style="width: 100%;">
                            <label for="unitWeight" style="min-width: 110px;">Peso unita(kg)</label>
                            <input type="text" id="unitWeight" class="number-input wide-input" value="">
                        </div>
                    </div>
                    <div class="form-row" style="margin-bottom: 1.2em;">
                        <div class="form-group" style="width: 100%;">
                            <label for="numPackages" style="min-width: 110px;">No Embalajes</label>
                            <input type="text" id="numPackages" class="number-input" value="">
                        </div>
                    </div>
                    <div class="modal-button-group">
                        <button type="submit" class="btn btn-save" style="font-weight:bold; font-size:1.1em; min-width:120px;">Guardar</button>
                        <button type="button" class="btn btn-close-packaging-modal" style="background:#f5f7fa; color:#2563eb; border:1.5px solid #2563eb; font-weight:bold; font-size:1.1em; min-width:120px;">Cerrar</button>
                    </div>
                </div>
                <!-- Pallet -->
                <div id="tabPalletContent" style="display:none;">
                    <fieldset class="form-row" style="display:flex; gap:1em; margin-bottom:1.2em; border:1px solid #e0e0e0; padding:0.8em;">
                        <legend style="font-size:0.85em; padding:0 0.4em;">Tipo de pallet</legend>
                        <label style="display:flex; align-items:center; gap:0.3em;">
                            <input type="radio" name="palletType" value="NORMAL"> Normal
                        </label>
                        <label style="display:flex; align-items:center; gap:0.3em;">
                            <input type="radio" name="palletType" value="MEDIANO"> Mediano
                        </label>
                        <label style="display:flex; align-items:center; gap:0.3em;">
                            <input type="radio" name="palletType" value="GRANDE"> Grande
                        </label>
                        <div style="margin-left:auto; display:flex; align-items:center; gap:0.4em;">
                            <label for="palletTotalWeight" style="min-width:110px;">Peso total (kg)</label>
                            <input type="text" id="palletTotalWeight" class="number-input" style="width:100px;" value="">
                        </div>
                    </fieldset>
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="form-row" style="gap: 1em; margin-bottom: 1.2em;">
                        <div class="form-group" style="flex: 1 1 60%; min-width: 180px;">
                            <label style="min-width: 110px;">Tipo embalaje</label>
                            <select class="pallet-caja-select" style="width: 100%;">
                                <option value="">CAJA C01</option>
                                <option value="">CAJA C02</option>
                                <option value="">CAJA C03</option>
                                <option value="">CAJA C04</option>
                                <option value="">CAJA C05</option>
                                <option value="">CAJA C06</option>
                                <option value="">CAJA C07</option>
                                <option value="">CAJA C08</option>
                                <option value="">CAJA C09</option>
                                <option value="">CAJA C10</option>
                                <option value="">CAJA C11</option>
                                <option value="">CAJA C12</option>
                                <option value="">CAJA C13</option>
                                <option value="">CAJA C15</option>
                                <option value="">CAJA C16</option>
                                <option value="">CAJA C17</option>
                                <option value="">CAJA C21</option>
                                <option value="">CAJA C23</option>
                                <option value="">CAJA C25</option>
                                <option value="">CAJA C27</option>
                                <option value="">CAJA C30</option>
                                <option value="">CAJA C31</option>
                                <option value="">CAJA MUESTRAS TERMOFORMADO</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1 1 35%; min-width: 100px;">
                            <label style="min-width: 50px;">Cant.</label>
                            <input type="text" class="number-input" value="">
                        </div>
                    </div>
                    <div class="modal-button-group">
                        <button type="submit" class="btn btn-save" style="font-weight:bold; font-size:1.1em; min-width:120px;">Guardar</button>
                        <button type="button" class="btn btn-close-packaging-modal" style="background:#f5f7fa; color:#2563eb; border:1.5px solid #2563eb; font-weight:bold; font-size:1.1em; min-width:120px;">Cerrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="packagingTypeSelectionModal" class="modal">
        <div class="modal-content type-selection-content">
            <h2>Agregar embalaje</h2>
            <div class="type-list-container">
                <select name="packagingTypeList" id="packagingTypeList"></select>
            </div>
            <div class="modal-button-group">
                <button type="button" class="btn btn-cancel-selection">Cancelar</button>
                <button type="button" class="btn btn-ok-selection">Ok</button>
            </div>
        </div>
    </div>

    <div id="editPalletBoxesModal" class="modal">
        <div class="modal-content">
            <h2>Cajas Pallet Crear</h2>
            <div class="order-info">Orden 1 Linea 2 Embarque 1 Linea 1</div>
            <div class="input-row">
                <select class="box-select" id="boxSelect1">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty1" value="0" min="0">
            </div>
            <div class="input-row">
                <select class="box-select" id="boxSelect2">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty2" value="0" min="0">
            </div>
            <div class="input-row">
                <select class="box-select" id="boxSelect3">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty3" value="0" min="0">
            </div>
            <div class="input-row">
                <select class="box-select" id="boxSelect4">
                    <option value="">Seleccione caja...</option>
                </select>
                <input type="number" class="box-qty" id="boxQty4" value="0" min="0">
            </div>
            <div class="modal-button-group button-group">
                <button class="cancel btn-close-pallet-boxes-modal">Cancelar</button>
                <button class="accept" id="acceptPalletBoxesBtn">Aceptar</button>
            </div>
        </div>
    </div>

    <button id="miBoton">Contar Registros</button>
    <!-- Limpieza: removido script obsoleto main-hh.js -->
    
<script type="module">
import { initDB, getAllData, addEntry } from './assets/js/modules/db.js';
import { populateSelect, renderEntries, wireEntryDeletion } from './assets/js/modules/ui.js';

const packagesList = document.getElementById('packagesList');
wireEntryDeletion(packagesList);

let userName = localStorage.getItem('userName');
if (userName) document.getElementById('userName').textContent = userName;

let dbReady = initDB().then(()=>{
    // Load data
    getAllData().then(data=>{
        if(!data.length){
            fetch('/api/packingList').then(r=>r.json()).then(api=>{
                if(api.status==='success'){
                    api.value.forEach(item=>{ if(item.Packing_Description.includes('CAJA')) addEntry({kind:'CATALOGO', pkgCode:item.Packing_PkgCode}); });
                    populateSelect(document.getElementById('packagingTypeList1'), api.value.filter(i=>i.Packing_Description.includes('CAJA')));
                }
            });
        } else {
            populateSelect(document.getElementById('packagingTypeList1'), data);
        }
    });
    renderEntries(packagesList);
});

// Open modal
const addPackagingModal = document.getElementById('addPackagingModal');
document.querySelector('.btn-add').addEventListener('click',()=>{ addPackagingModal.style.display='flex'; });
document.querySelector('.btn-close-packaging-modal').addEventListener('click',()=>{ addPackagingModal.style.display='none'; });

const selectCaja = document.getElementById('packagingTypeList1');
selectCaja.addEventListener('change', e=>{
    // length/width/height would come from catalog; placeholder logic
});

document.getElementById('packagingForm').addEventListener('submit', e=>{
    e.preventDefault();
    const pkgCode = selectCaja.value;
    const length = Number(document.getElementById('length').value)||0;
    const width = Number(document.getElementById('width').value)||0;
    const height = Number(document.getElementById('height').value)||0;
    const unitWeight = Number(document.getElementById('unitWeight').value)||0;
    const numPackages = Number(document.getElementById('numPackages').value)||0;
    if(!pkgCode){ alert('Seleccione caja'); return; }
    addEntry({kind:'CAJA', pkgCode, length,width,height,unitWeight,numPackages});
    addPackagingModal.style.display='none';
    renderEntries(packagesList);
    e.target.reset();
});
</script>
</body>
</html>